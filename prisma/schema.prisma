generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int @id @default(autoincrement())
  name         String
  email        String   @unique
  password     String
  user_wallet  String?
  user_type    Int      @default(0) // 0 = admin, 1 = student
  is_verified  Int      @default(1) // 0 = nothing , 1 = can issue / revoke 
  image        String?
  createdAt    DateTime @default(now())

  certificates Certificate[] @relation("IssuedCertificates")
  revocationHistory Revocation[] @relation("RevocationUser")
  revocationRequests RevocationRequest[] @relation("RequestorUser")
}

model Certificate {
  id                 Int @id @default(autoincrement())
  destination_wallet String
  nftAddress         String   @unique
  ipfsUrl            String
  mintedAt           DateTime @default(now())
  issuedById         Int
  issuedBy           User     @relation("IssuedCertificates", fields: [issuedById], references: [id])

  metadataUri      String?   // Hash of metadata to detect changes
  revoked           Boolean   @default(false)

  revocationHistory Revocation[] @relation("Revocation")
  revocationRequests RevocationRequest[] @relation("CertificateRequests")
}

model Revocation {
  id            Int         @id @default(autoincrement())
  certificateId Int
  certificate   Certificate @relation("Revocation" , fields: [certificateId], references: [id])
  revokedById   Int
  revokedBy     User        @relation("RevocationUser" , fields: [revokedById], references: [id])
  reason        String      @db.Text
  revokedAt     DateTime    @default(now())
  
  transactionSignature String? @map("tx_signature")

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([certificateId])
  @@index([revokedById])
  @@index([revokedAt])
}

model RevocationRequest {
  id            Int         @id @default(autoincrement())
  certificateId Int
  certificate   Certificate @relation("CertificateRequests", fields: [certificateId], references: [id])
  requestedById Int
  requestedBy   User        @relation("RequestorUser", fields: [requestedById], references: [id])
  reason        String      @db.Text

  adminNotes    String?     @db.Text
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([certificateId])
  @@index([requestedById])
}
